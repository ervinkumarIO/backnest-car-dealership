# 📁 File Structure Documentation

## 🏗️ Project Structure Overview

```
car-dealership-backend-nest/
├── docs/                          # Documentation files
│   ├── 01-ARCHITECTURE-OVERVIEW.md
│   ├── 02-DATABASE-DESIGN.md
│   ├── 03-AUTHENTICATION-SYSTEM.md
│   ├── 04-API-DOCUMENTATION.md
│   └── 05-FILE-STRUCTURE.md
├── src/                           # Source code
│   ├── admin/                     # Admin management module
│   ├── auth/                      # Authentication module
│   ├── cars/                      # Car management module
│   ├── common/                    # Shared utilities
│   ├── entities/                  # Database entities
│   ├── staff/                     # Staff management module
│   ├── app.controller.spec.ts     # App controller tests
│   ├── app.controller.ts          # Root application controller
│   ├── app.module.ts              # Root application module
│   ├── app.service.ts             # Root application service
│   └── main.ts                    # Application entry point
├── test/                          # End-to-end tests
├── dist/                          # Compiled JavaScript (auto-generated)
├── node_modules/                  # Dependencies (auto-generated)
├── .env                           # Environment variables (create manually)
├── .env.example                   # Environment template
├── .gitignore                     # Git ignore rules
├── .prettierrc                    # Code formatting config
├── eslint.config.mjs              # Linting configuration
├── nest-cli.json                  # NestJS CLI configuration
├── package.json                   # Project dependencies
├── package-lock.json              # Dependency lock file
├── README.md                      # Project overview
├── tsconfig.build.json            # TypeScript build config
└── tsconfig.json                  # TypeScript configuration
```

## 📂 Core Directories

### `/src` - Source Code Directory

The main application source code organized by feature modules.

### `/docs` - Documentation Directory

Comprehensive project documentation including architecture, API specs, and guides.

### `/test` - Testing Directory

End-to-end test files and testing configuration.

### `/dist` - Distribution Directory

Compiled JavaScript output (auto-generated by TypeScript compiler).

## 🏗️ Module Structure

Each feature module follows NestJS conventions with consistent organization:

```
module-name/
├── dto/                    # Data Transfer Objects
│   ├── create-*.dto.ts     # Creation validation schemas
│   ├── update-*.dto.ts     # Update validation schemas
│   ├── *.dto.ts           # Additional DTOs
│   └── index.ts           # Export barrel file
├── *.controller.ts        # HTTP request handlers
├── *.service.ts           # Business logic
└── *.module.ts            # Module definition
```

## 🔐 Authentication Module (`/src/auth`)

**Purpose**: Handles user authentication, JWT tokens, and session management.

```
src/auth/
├── dto/
│   └── login.dto.ts              # Login request validation
├── strategies/
│   ├── jwt.strategy.ts           # JWT token validation
│   └── local.strategy.ts         # Username/password validation
├── auth.controller.ts            # Authentication endpoints
├── auth.module.ts                # Authentication module config
├── auth.service.ts               # Authentication business logic
└── session.serializer.ts        # Session persistence
```

### File Details:

#### `auth.module.ts` - Module Configuration
- **Purpose**: Configures authentication providers and strategies
- **Dependencies**: ConfigModule, PassportModule, JwtModule, TypeORM
- **Exports**: AuthService for use in other modules
- **Key Features**:
  - JWT configuration with environment-based secrets
  - Passport strategies registration
  - Database entity imports

#### `auth.service.ts` - Core Authentication Logic
- **Purpose**: User validation, password hashing, JWT generation
- **Key Methods**:
  - `validateUser()`: Credential verification
  - `login()`: JWT token generation
  - `hashPassword()`: bcrypt password hashing
  - `findUserById()`: User retrieval for token validation
- **Security Features**: 12-round bcrypt hashing, active user checks

#### `auth.controller.ts` - HTTP Endpoints
- **Purpose**: Handles login requests and profile retrieval
- **Endpoints**:
  - `POST /auth/admin/login`: Admin user login
  - `POST /auth/staff/login`: Staff user login
  - `POST /auth/session/login`: Session-based login
  - `GET /auth/profile`: Current user profile

#### `strategies/jwt.strategy.ts` - JWT Validation
- **Purpose**: Validates JWT tokens on protected routes
- **Configuration**: Bearer token extraction, expiration enforcement
- **Security**: User existence verification, active status check

#### `strategies/local.strategy.ts` - Local Authentication
- **Purpose**: Username/password validation for sessions
- **Configuration**: Email as username field
- **Integration**: Uses AuthService for credential validation

#### `session.serializer.ts` - Session Management
- **Purpose**: Handles user session serialization/deserialization
- **Methods**:
  - `serializeUser()`: Store minimal user info in session
  - `deserializeUser()`: Retrieve full user from session data

## 👥 Admin Module (`/src/admin`)

**Purpose**: Master-only admin user management with full CRUD operations.

```
src/admin/
├── dto/
│   ├── create-admin.dto.ts       # Admin creation validation
│   ├── update-admin.dto.ts       # Admin update validation
│   └── index.ts                  # DTO exports
├── admin.controller.ts           # Admin CRUD endpoints
├── admin.module.ts               # Admin module configuration
└── admin.service.ts              # Admin business logic
```

### File Details:

#### `admin.service.ts` - Business Logic
- **Purpose**: Admin CRUD operations with security
- **Key Methods**:
  - `findAll()`: Paginated admin listing (excludes Master users)
  - `create()`: Admin creation with password hashing
  - `update()`: Admin updates with optional password change
  - `remove()`: Safe admin deletion
- **Security**: Password hashing, Master exclusion from listings

#### `admin.controller.ts` - HTTP Endpoints
- **Purpose**: RESTful admin management endpoints
- **Access Control**: All endpoints require Master role (`@MasterOnly()`)
- **Features**: Standard CRUD with pagination support

#### `dto/create-admin.dto.ts` - Creation Validation
- **Purpose**: Validates admin creation requests
- **Validations**:
  - Email format and uniqueness
  - Password minimum length (6 characters)
  - Required fields (name, branch)
  - Role enum validation

## 👨‍💼 Staff Module (`/src/staff`)

**Purpose**: Admin+ staff management with branch-based filtering.

```
src/staff/
├── dto/
│   ├── create-staff.dto.ts       # Staff creation validation
│   ├── update-staff.dto.ts       # Staff update validation
│   └── index.ts                  # DTO exports
├── staff.controller.ts           # Staff CRUD endpoints
├── staff.module.ts               # Staff module configuration
└── staff.service.ts              # Staff business logic
```

### File Details:

#### `staff.service.ts` - Business Logic with Branch Filtering
- **Purpose**: Staff CRUD with branch-based access control
- **Key Methods**:
  - `findAll()`: Branch-filtered staff listing
  - `findOne()`: Single staff with branch authorization
  - `getSoldBySelector()`: Staff IDs for dropdowns
- **Branch Logic**:
  - Master users: See all staff
  - Admin users: See only same branch staff
  - Authorization checks on individual operations

#### `staff.controller.ts` - HTTP Endpoints
- **Purpose**: RESTful staff management endpoints
- **Access Control**: All endpoints require Admin+ role (`@AdminOnly()`)
- **Special Endpoints**: `sold-by-selector` for UI dropdowns

## 🚗 Cars Module (`/src/cars`)

**Purpose**: Comprehensive car inventory management system.

```
src/cars/
├── dto/
│   ├── create-car.dto.ts         # Car creation validation
│   ├── update-car.dto.ts         # Car update validation
│   ├── bulk-update-price.dto.ts  # Bulk price update validation
│   ├── bulk-update-status.dto.ts # Bulk status update validation
│   ├── bulk-update-public.dto.ts # Bulk public visibility validation
│   ├── bulk-delete.dto.ts        # Bulk delete validation
│   └── index.ts                  # DTO exports
├── car-images.controller.ts      # Image upload/management
├── car-store.controller.ts       # New car creation
├── cars.controller.ts            # Main car CRUD/bulk operations
├── cars.module.ts                # Cars module configuration
├── cars.service.ts               # Car business logic
├── public-view.controller.ts     # Public car viewing
└── s3.service.ts                 # AWS S3 integration
```

### File Details:

#### `cars.service.ts` - Core Business Logic
- **Purpose**: Comprehensive car management operations
- **Key Methods**:
  - `findAll()`: Advanced search with filtering and pagination
  - `getCarListing()`: Simplified listing for admin dashboard
  - `getCarStats()`: Inventory statistics
  - `bulkUpdatePrice()`: Bulk price modifications
  - `bulkUpdateStatus()`: Bulk status changes
  - `getFacets()`: Search facet generation
  - `getPublicCars()`: Public car filtering
- **Features**: Query builder integration, complex filtering logic

#### `cars.controller.ts` - Main Car Endpoints
- **Purpose**: Primary car management endpoints
- **Access Control**: Admin+ access required
- **Endpoints**: Full CRUD plus bulk operations
- **Features**: Search, filtering, statistics, faceted search

#### `car-store.controller.ts` - Car Creation
- **Purpose**: Dedicated endpoint for new car creation
- **Endpoint**: `POST /cars/store-new`
- **Features**: Transaction support, validation, error handling

#### `car-images.controller.ts` - Image Management
- **Purpose**: Car image upload and management
- **Features**:
  - Direct file uploads
  - Presigned URL generation
  - Image deletion
  - Car-specific image association
- **Integration**: AWS S3 service for cloud storage

#### `public-view.controller.ts` - Public API
- **Purpose**: Public-facing car viewing endpoints
- **Access**: No authentication required
- **Features**: Public car browsing, search, best cars showcase
- **Filtering**: Only public cars (public=yes, status=In Stock)

#### `s3.service.ts` - AWS S3 Integration
- **Purpose**: Cloud storage operations for car images
- **Features**:
  - File uploads with unique naming
  - Presigned URL generation
  - Image deletion
  - Database integration for URL storage
- **Configuration**: Environment-based AWS credentials

## 🗃️ Entities Directory (`/src/entities`)

**Purpose**: Database entity definitions using TypeORM.

```
src/entities/
├── admin.entity.ts               # Admin user entity
├── base.entity.ts                # Base entity with common fields
├── car.entity.ts                 # Car inventory entity
├── staff.entity.ts               # Staff user entity
└── index.ts                      # Entity exports
```

### File Details:

#### `base.entity.ts` - Common Entity Fields
- **Purpose**: Abstract base class for common entity fields
- **Fields**: id, created_at, updated_at, deleted_at
- **Features**: Soft delete support, automatic timestamps

#### `car.entity.ts` - Car Entity
- **Purpose**: Core business entity for car inventory
- **Key Features**:
  - chassisNo as primary key (business requirement)
  - JSON fields for features and images
  - Custom timestamps (no BaseEntity inheritance)
  - Comprehensive car specifications

#### `admin.entity.ts` & `staff.entity.ts` - User Entities
- **Purpose**: User management entities with role-based fields
- **Common Features**: Email authentication, role enums, branch assignment
- **Differences**: Admin has Master/Admin roles, Staff has department assignments

## 🛠️ Common Directory (`/src/common`)

**Purpose**: Shared utilities used across modules.

```
src/common/
├── decorators/
│   └── roles.decorator.ts        # Role-based access decorators
├── filters/
│   └── http-exception.filter.ts  # Global error handling
├── guards/
│   ├── branch.guard.ts           # Branch-based access control
│   └── roles.guard.ts            # Role-based access control
└── index.ts                      # Common utilities export
```

### File Details:

#### `decorators/roles.decorator.ts` - Access Control Decorators
- **Purpose**: Convenient decorators for role-based access control
- **Decorators**:
  - `@Roles()`: Generic role specification
  - `@MasterOnly()`: Master-only access
  - `@AdminOnly()`: Admin+ access
  - `@StaffOnly()`: Staff-specific access

#### `guards/roles.guard.ts` - Role Authorization
- **Purpose**: Enforces role-based access control
- **Logic**: Validates user roles against endpoint requirements
- **Integration**: Works with role decorators

#### `guards/branch.guard.ts` - Branch Authorization
- **Purpose**: Branch-based access filtering
- **Logic**: Master bypass, branch restriction for others

#### `filters/http-exception.filter.ts` - Error Handling
- **Purpose**: Consistent error response formatting
- **Features**: Structured error responses with context

## 🏁 Root Files (`/src`)

### `main.ts` - Application Entry Point
- **Purpose**: Application bootstrap and configuration
- **Features**:
  - Security middleware (Helmet, CORS)
  - Global validation pipes
  - Exception filters
  - Environment-based configuration

### `app.module.ts` - Root Module
- **Purpose**: Application module orchestration
- **Imports**: All feature modules, configuration modules
- **Configuration**: Database, rate limiting, environment

### `app.controller.ts` & `app.service.ts` - Default Endpoints
- **Purpose**: Basic health check and welcome endpoints
- **Usage**: Development and deployment verification

## 🔧 Configuration Files

### `package.json` - Project Configuration
- **Purpose**: Dependencies, scripts, project metadata
- **Scripts**: Development, build, test, deployment
- **Dependencies**: NestJS, TypeORM, Authentication, AWS SDK

### `tsconfig.json` - TypeScript Configuration
- **Purpose**: TypeScript compilation settings
- **Features**: Decorator support, strict type checking, module resolution

### `.env` & `.env.example` - Environment Configuration
- **Purpose**: Environment-specific configuration
- **Contents**: Database, JWT secrets, AWS credentials, CORS settings

### `nest-cli.json` - NestJS CLI Configuration
- **Purpose**: CLI behavior and project structure
- **Features**: Source root, compiler options

This file structure provides clear separation of concerns, maintainable code organization, and scalable architecture for the car dealership management system. 